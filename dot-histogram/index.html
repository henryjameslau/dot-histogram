<!DOCTYPE html>
<html lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='ext/css'>
  <title></title>

  <meta name="description" content="">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <link rel="stylesheet" href="../lib/globalStyle.css" />
  <link rel="stylesheet" href="../lib/bootstrap-grid.css" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">

  <style type="text/css">
    h6 {
      font-size: 16px;
      margin: 16px 0 8px 0;
      font-weight: 700;
      color: #323132;
    }
  </style>

</head>


<body>

  <div class="container-fluid">
    <div id="graphic" class="row no-gutters">
      <img src="fallback.png" alt="[Chart]" />
    </div>
  </div>

  <h6 id="source"></h6>

  <script src="../lib/modernizr.svg.min.js" type="text/javascript"></script>
  <script src="https://cdn.ons.gov.uk/vendor/d3/4.13.0/d3.min.js" type="text/javascript"></script>
  <script src="https://cdn.ons.gov.uk/vendor/pym/1.3.2/pym.min.js" type="text/javascript"></script>

  <script>
    var graphic = d3.select('#graphic');
    var source = d3.select('#source');
    var pymChild = null;

    function drawGraphic(width) {
      // clear out existing graphics
      graphic.selectAll("*").remove();
      source.selectAll("*").remove();

      var threshold_md = dvc.optional.mediumBreakpoint;
      var threshold_sm = dvc.optional.mobileBreakpoint;

      //set variables for chart dimensions dependent on width of #graphic
      if (parseInt(graphic.style("width")) < threshold_sm) {
        var margin = {
          top: dvc.optional.margin_sm[0],
          right: dvc.optional.margin_sm[1],
          bottom: dvc.optional.margin_sm[2],
          left: dvc.optional.margin_sm[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
      } else if (parseInt(graphic.style("width")) < threshold_md) {
        var margin = {
          top: dvc.optional.margin_md[0],
          right: dvc.optional.margin_md[1],
          bottom: dvc.optional.margin_md[2],
          left: dvc.optional.margin_md[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
      } else {
        var margin = {
          top: dvc.optional.margin_lg[0],
          right: dvc.optional.margin_lg[1],
          bottom: dvc.optional.margin_lg[2],
          left: dvc.optional.margin_lg[3]
        };
        var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
      }

      var legend = graphic.append('svg')
        .append("g")
        .attr("id", "legend");

      var svg = graphic.select('svg')
        .attr("id", "chart")
        .style("background-color", "#fff")
        .attr("width", chart_width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom) //+30)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var x = d3.scaleLinear()
        .rangeRound([0, chart_width]);

      const range = (from, to, step) =>
        Array(~~((to - from) / step) + 1) // '~~' is Alternative for Math.floor()
        .fill().map((v, i) => from + i * step);

      console.log("graphic_data", graphic_data)

      myAgeData = graphic_data.filter(function(d) {
        return +d.Age === 20
      })

      console.log('myAgeData', myAgeData)
      var myDistribution = createDistribution(myAgeData)
      console.log('myDistribution', myDistribution)

      xMax = d3.max([+myAgeData[0]["D10"], +myAgeData[1]["D10"]])
      x.domain([0, xMax]).nice();

      var histogram = d3.histogram()
        .value(function(d) {
          return d
        })
        .domain(x.domain())
        .thresholds(range(x.domain()[0], x.domain()[1], 1))

      var histos = myDistribution.map(function(d) {
        var thisHisto = d3.histogram()
          .value(function(d) {
            return d
          })
          .domain(x.domain())
          .thresholds(range(x.domain()[0], x.domain()[1], 1))

        return {
          gender: d.Gender,
          age: d.Age,
          values: thisHisto(d.values),
          no: d.values.length
        }
      })
      console.log(histos)
      var xAxis = d3.axisBottom(x);

      var sides = svg.selectAll(".sides")
        .data(histos)
        .enter()
        .append('g')
        .attr('id', function(d) {
          return d.gender
        })

      var radius = x(1) - x(0.5)


      sides.selectAll('circle')
        .data(function(d){return d.values.map(function(p,i){
              return {gender:d.gender,age:d.age,x:p.x0,idx:i}
          })
        })
        .enter()
        .append('circle')
        .attr('cx',function(d){console.log(d);return x(d.x)})
        .attr('cy',function(d){return -d.idx * 2 * radius - radius})
        .attr('r', x(1) - x(0.6))
        .attr('fill', "blue")


      // var bins = sides.selectAll('.bins')
      //   .data(function(d) {
      //     console.log(d)
      //     return d.values
      //   })
      //   .enter()
      //   .append('g')
      //   .attr('class', 'bins')
      //   .attr('transform', function(d) {
      //     return 'translate(' + x(d.x0) + ',' + height / 2 + ')'
      //   })


      // var binsMale = svg.selectAll('.bins')
      //   .data(maleDotHisto)
      //   .enter()
      //   .append('g')
      //   .attr('class','bins')
      //   .attr('transform',function(d){return 'translate('+x(d.x0)+','+height/2+')'})
      //
      //
      // bins.selectAll('circle')
      //   .data(function(d) {
      //     // console.log(d)
      //     return d.map(function(p, i) {
      //       return {
      //         data:p,
      //         idx: i
      //       }
      //     })
      //   })
      //   .enter()
      //   .append('circle')
      //   .attr('cx', 0)
      //   .attr('cy', function(d) {
      //     // console.log(d);
      //     return -d.idx * 2 * radius - radius
      //   })
      //   .attr('r', x(1) - x(0.6))
      //   .attr('fill', "blue")

      // var binsFemale = svg.selectAll('.bins')
      //     .data()

      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis)

    } // ends drawGraphic

    function createDistribution(data) {
      var dummy = []
      test = data.map(function(d) {
        var filled = []
        fillNumbers(10, [d.D0, d.D1]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D1, d.D2]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D2, d.D3]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D3, d.D4]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D4, d.D5]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D5, d.D6]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D6, d.D7]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D7, d.D8]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D8, d.D9]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D9, d.D10]).forEach(function(e) {
          filled.push(e)
        })
        dummy.push({
          Gender: d.Sex,
          Age: d.Age,
          values: filled
        });
      })
      return dummy
    }



    function fillNumbers(N, fillrange) {
      var count = +N;
      var res = [];
      var step = (fillrange[1] - fillrange[0]) / count
      var v0 = +fillrange[0];
      for (i = 0; i < N; i++) {
        var tmp = v0 + (i * +step);
        res.push(Math.round(tmp * 1e3) / 1000)
      }
      return res
    }

    //check whether browser can cope with svg
    if (Modernizr.svg) {
      //load config
      d3.json("config.json", function(error, config) {
        dvc = config

        //load chart data
        d3.csv(dvc.essential.graphic_data_url, function(error, data) {
          graphic_data = data;

          //use pym to create iframed chart dependent on specified variables
          pymChild = new pym.Child({
            renderCallback: drawGraphic
          });
        });
      })

    } else {
      //use pym to create iframe containing fallback image (which is set as default)
      pymChild = new pym.Child();
      if (pymChild) {
        pymChild.sendHeight();
      }
    }
  </script>
</body>

</html>
