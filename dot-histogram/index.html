<!DOCTYPE html>
<html lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='ext/css'>
  <title></title>

  <meta name="description" content="">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <link rel="stylesheet" href="../lib/globalStyle.css" />
  <link rel="stylesheet" href="../lib/bootstrap-grid.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  <style type="text/css">
    h6 {
      font-size: 16px;
      margin: 16px 0 8px 0;
      font-weight: 700;
      color: #323132;
    }

    h4 {
      font-size: 16px;
      line-height: 24px;
      margin: 16px 0 8px 0;
      padding: 24px 0 0 0;
      font-weight: 700;
    }

    h5 {
      font-size: 14px;
      margin: 0 0 16px 0;
      font-weight: 400;
      padding-top: 0;
    }

    path.domain {
      opacity: 0;
    }

    .tick line {
      stroke-dasharray: 2 2;
    }

    g.annotation-subject path.subject {
      fill: #FF9933;
      fill-opacity: 1;
      stroke: #323132;
    }


    .btn-group {
      padding: 10px;
      overflow: auto;
    }

    .btn-group,
    .btn-group-vertical {
      position: relative;
      display: inline-block;
      vertical-align: middle;
    }

    .btn-group>.btn:first-child:not(:last-child):not(.dropdown-toggle) {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .btn-group .btn {
      float: left;
      margin: 0;
      margin-right: 0px;
      margin-bottom: 0px;
      margin-left: 0px;
      border-right: 1px solid #D0D2D3;
    }

    .btn-group-vertical>.btn,
    .btn-group>.btn {
      position: relative;
      float: left;
    }

    .btn {
      position: relative;
      padding: 10px 15px;
      margin: 0 0 20px;
      line-height: normal;
      color: #fff;
      font-size: 1.3em !important;
      border-radius: 0px;
      display: inline-block;
      text-rendering: optimizeLegibility;
      transition: background-color .2s ease-in, color .2s ease-in;
    }

    .btn {
      font-family: "Open Sans", Helvetica, Arial, sans-serif;
      font-weight: 400;
      font-size: 14px;
      display: inline-block;
      width: auto;
      cursor: pointer;
      padding: 6px 16px 10px 16px;
      border: 0 none;
      text-align: center;
      -webkit-appearance: none;
      transition: background-color 0.25s ease-out;
      text-decoration: none;
      line-height: 24px;
    }

    .btn {
      display: inline-block;
      padding: 6px 12px;
      margin-bottom: 0;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.42857143;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      -ms-touch-action: manipulation;
      touch-action: manipulation;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      background-image: none;
      border: 1px solid transparent;
      border-radius: 4px;
    }

    .btn--select {
      margin-left: 0px !important;
    }

    .btn--select {
      color: #206095;
      border: 2px solid #206095;
      margin-right: 15px;
      margin-bottom: 15px;
      transition: all ease .2s;
      /* border-radius: 30px !important; */
    }

    .btn--primary {
      background-color: #206095;
    }

    .btn--primary-disabled {
      opacity: 0.7;
      color: #5f7682;
      background-color: #d0d2d3;
      cursor: not-allowed;
    }

    .btn--primary-disabled:active {
      opacity: 0.7;
      color: #5f7682;
      background-color: #d0d2d3;
      cursor: not-allowed;
    }

    .btn--restart::after {
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      content: "\f2f9";
      margin-left: 10px;
    }

    data-toggle="buttons"]>.btn input[type="checkbox"],
    [data-toggle="buttons"]>.btn input[type="radio"],
    [data-toggle="buttons"]>.btn-group>.btn input[type="checkbox"],
    [data-toggle="buttons"]>.btn-group>.btn input[type="radio"] {
      position: absolute;
      clip: rect(0, 0, 0, 0);
      pointer-events: none;
    }

    input[type="checkbox"],
    input[type="radio"] {
      -webkit-appearance: none;
    }

    .btn-group input {
      height: 0px;
      width: 0px;
      position: absolute;
      left: -100px;
    }

    input[type="checkbox"],
    input[type="radio"] {
      margin: 4px 0 0;
      margin-top: 1px\9;
      line-height: normal;
    }

    input[type="checkbox"],
    input[type="radio"] {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      padding: 0;
    }

    input {
      border: none;
      border-bottom-color: currentcolor;
      border-bottom-style: none;
      border-bottom-width: medium;
      border-radius: 0;
      border-bottom: solid 1px #ddd;
      font-size: 18px;
      line-height: 32px;
      margin: 16px 0;
      padding: 6px 0 0 0;
    }

    input,
    select {
      font-family: "Open Sans", Helvetica, Arial, sans-serif;
      font-size: 14px;
    }

    button,
    input,
    select,
    textarea {
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
    }

    input {
      line-height: normal;
    }

    button,
    input,
    optgroup,
    select,
    textarea {
      margin: 0;
      font: inherit;
      font-size: inherit;
      line-height: inherit;
      font-family: inherit;
      color: inherit;
    }

    .btn-group-vertical>.btn.active,
    .btn-group-vertical>.btn:active,
    .btn-group-vertical>.btn:focus,
    .btn-group-vertical>.btn:hover,
    .btn-group>.btn.active,
    .btn-group>.btn:active,
    .btn-group>.btn:focus,
    .btn-group>.btn:hover {
      z-index: 2;
    }

    .btn:active,
    .btn.active {
      -webkit-box-shadow: none;
      box-shadow: 0 0 0pt 3pt orange;
    }

    .btn--select:hover {
      background-color: #206095;
      color: white !important;
    }

    .btn--select:active,
    .btn--select.active {
      color: white;
      background-color: #206095;
      box-shadow: 0 0 0pt 3pt orange;
    }

    .btn:focus,
    .btn.focus {
      outline: none;
      box-shadow: 0px 0px 0 3px #FFA23A;
      color: white;
      outline-offset: 0px;
    }

    legend {
      display: block;
      width: 100%;
      padding: 0;
      font-size: 21px;
      line-height: inherit;
      color: #333;
      border: 0;
      border-bottom: 1px solid #e5e5e5;
    }

    legend {
      border: 0px;
      margin: 20px 0 10px 0;
    }

    button.minus,
    button.plus {
      width: 34px;
      height: 30px;
      background-color: #1b5f97;
      color: #fff;
      border: 2px solid #1b5f97;
      box-sizing: border-box;
      font-size: 13px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      display: block;
      line-height: 50%;
      float: left;
    }

    input {
      background: transparent;
      border: none;
    }

    input[type=number] {
      border: none;
      border-radius: 0;
      /* border: 2px solid #1b5f97; */
      font-size: 20px;
      line-height: 20px;
      width: 55px;
      /* margin: 16px 0; */
      padding: 6px 0 6px 0;
      width: 60px;
      text-align: center;
      float: left;
      -moz-appearance: textfield;
      appearance: textfield;
    }

    input:focus {
      outline: 3px solid #FFA23A;
      z-index: 1;
      outline-offset: -3px;
    }

    .borderbox {
      border: 2px solid #1b5f97;
      height: 34px;
      width: 132px;
      display: inline-block;
    }

    button:focus {
      outline: 3px solid #f93;
    }


    .select::after {
      content: '';
      position: absolute;
      top: 0;
      width: 0;
      height: 0;
      right: 9px;
      bottom: 0;
      margin: auto;
      border-style: solid;
      border-width: 8px 8px 0 8px;
      border-color: #ffffff transparent transparent transparent;
      pointer-events: none;
    }

    ::after,
    ::before {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .select::before {
      width: 34px;
      position: absolute;
      top: 1px;
      right: 1px;
      bottom: 1px;
      background: #206095;
      content: '';
      pointer-events: none;
    }

    .select {
      position: relative;
      height: 34px;
      background: white;
      border: none;
      width: 134px;
      ;
    }

    .select select {
      font-size: 1.1em;
      border: none;
      box-shadow: none;
      border-radius: 0;
      background: transparent;
      height: 100%;
      width: 100%;
      cursor: pointer;
      outline: none;
      padding-right: 35px;
      padding-left: 4px;
      border: 2px solid #206095;
      -moz-appearance: none;
      -webkit-appearance: none;
    }

    .bold {
      font-weight: 700;
      color: #206595;
      font-size: 20px;
    }

    .white {
      color: white;
    }

    .btn--next::after {
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      content: "\f054";
      margin-left: 10px;
    }

    path.note-line {
      opacity: 0
    }

    .averageLine {
      opacity: 0;
    }



    .pound {
      float: left;
      display: inline;
      height: 30px;
      width: 34px;
      font-size: 21px;
      background-color: #206095;
      color: #fff;
      text-align: center;
      float: left;
      font-weight: 600;
      box-sizing: border-box;
      padding-top: 2px;
    }
  </style>

</head>


<body>
  <div>
    <div id="part1" class="row no-gutters">
      <div class="col-1" id="timeline"></div>
      <div class="col-11" id="inputs">


        <legend>Age</legend>

        <!-- <input id='age' type="number" name="age" value="20" min="18" max="70"> -->

        <div class="borderbox">
          <span style="display:inline-block; text-align: center;">
            <button type="button" id="minus" class="minus"><i class="fas fa-minus white"></i></button>
            <input class="bold" id="age" type="number" value="20" max="65" min="18">
            <button type="button" id="plus" class="plus"><i class="fas fa-plus white"></i></button>

            <!-- </span><span style="display:inline-block;vertical-align:top;"> -->
          </span></div>


        <legend>Sex</legend>

        <div class="btn btn--select bold" aria-labelledby="Male">
          <input type="radio" name="gender" value="Male" autocomplete="off" tabindex="0">Male
        </div>
        <div class="btn btn--select bold" tabindex="0" aria-labelledby="Female">
          <input type="radio" name="gender" value="Female" autocomplete="off" tabindex="0" checked>Female
        </div>


        <legend>Commute time (mins)</legend>
        <div class="borderbox">
          <button type="button" id="minus2" class="minus"><i class="fas fa-minus white"></i></button>
          <input class="bold" type="number" id="commuteTimeInput" name="commuteTime" value="22" min="00" max="120">
          <button type="button" id="plus2" class="plus"><i class="fas fa-plus white"></i></button>
        </div>

        <legend>Earnings</legend>
        <div>
          <div class="borderbox" style="float:left;">
            <div class="pound">£</div>
            <input style="width:73%" class="bold" id='income' type="number" name="income" step="0.01" value="5.7" min="0" max="100">
          </div>
          <div class="select" style="display:inline-block;margin-left:8px;">

            <select class="bold" name="select">
              <option selected="" disabled="">Select an option</option>
              <option value="byYear">per year</option>
              <option value="byHour">per hour</option>
            </select>

          </div>
        </div>

        <div style="padding-top:20px;">
          <button id="startButton" type="button" class="btn btn-group__btn btn--primary btn--green btn--next">Start</button>
        </div>
        <!-- end of inputs -->


      </div>
    </div>

    <div id="part2" class="d-none">
      <div id="chart-titles">
        <h4 id="title"></h4>
        <h5 id="subtitle"></h5>
      </div>
      <div id="graphic">
        <img src="fallback.png" alt="[Chart]" />
      </div>
      <h6 id="source">Source: Office for National Statistics</h6>

      <div>Compare the earnings of people who do a similar commute to you</div>
      <button class="btn btn--primary btn--next" id="incomeButton" type="button">Next</button>

      <button class="btn btn--primary btn--primary-disabled btn--restart" id="restart">Restart</button>
    </div>
  </div>


  <script src="../lib/modernizr.svg.min.js" type="text/javascript"></script>
  <script src="https://cdn.ons.gov.uk/vendor/d3/4.13.0/d3.min.js" type="text/javascript"></script>
  <script src="https://cdn.ons.gov.uk/vendor/pym/1.3.2/pym.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.3.2/d3-annotation.js" type="text/javascript"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script>
    var graphic = d3.select('#graphic');
    var row = d3.select(".row")
    var source = d3.select('#source');
    var pymChild = null;



    height = parseInt(d3.select('#inputs').style('height'))
    timelineWidth = parseInt(d3.select('#timeline').style("width"))
    timeline = d3.select('#timeline').append('svg').attr('height', height).attr('width', timelineWidth)

    timeline.append('line')
      .attr('x1', timelineWidth / 2)
      .attr('x2', timelineWidth / 2)
      .attr('y1', 77)
      .attr('y2', 395)
      .attr('stroke', 'grey')
      .attr('stroke-dasharray', '2 2')
      .attr('stroke-width', 2)

    timeline.selectAll('circle')
      .data([77, 182, 297, 395])
      .enter()
      .append('circle')
      .attr('cy', function(d, i) {
        return d
      })
      .attr('cx', timelineWidth / 2)
      .attr('r', 10).style('fill', 'white')
      .style('stroke', 'grey')
      .style('stroke-width', 2)

    //button group
    d3.selectAll('.btn--select').on('click', function(d) {
      console.log("click button")
      d3.selectAll('.btn--select').classed('active', false)
      d3.select(this).classed('active', true)
      d3.selectAll('.btn--select').selectAll('input').property('checked', false)
      d3.select(this).select('input').property('checked', true)
    })

    //stuff for the tally 1
    document.getElementById("plus").addEventListener("click", function() {
      var typenumber = document.getElementById("age").value
      if (typenumber + 1 <= document.getElementById("age").max) {
        document.getElementById("age").value = +typenumber + 1;
      }
    })
    document.getElementById("minus").addEventListener("click", function() {
      if (document.getElementById("age").value > 0) {
        var typenumber = document.getElementById("age").value
        if (typenumber - 1 >= document.getElementById("age").min) {
          document.getElementById("age").value = +typenumber - 1;
        }
      }
    })
    //tally2
    document.getElementById("plus2").addEventListener("click", function() {
      var typenumber = +document.getElementById("commuteTimeInput").value
      if (typenumber + 1 <= +document.getElementById("commuteTimeInput").max) {
        document.getElementById("commuteTimeInput").value = +typenumber + 1;
      }
    })
    document.getElementById("minus2").addEventListener("click", function() {
      if (document.getElementById("commuteTimeInput").value > 0) {
        var typenumber = document.getElementById("commuteTimeInput").value
        if (typenumber - 1 >= document.getElementById("commuteTimeInput").min) {
          document.getElementById("commuteTimeInput").value = +typenumber - 1;
        }
      }
    })


    function drawGraphic(width) {


      // clear out existing graphics
      graphic.selectAll("*").remove();
      source.selectAll("*").remove();

      var threshold_md = dvc.optional.mediumBreakpoint;
      var threshold_sm = dvc.optional.mobileBreakpoint;

      //set variables for chart dimensions dependent on width of #graphic
      if (parseInt(row.style("width")) < threshold_sm) {
        var margin = {
          top: dvc.optional.margin_sm[0],
          right: dvc.optional.margin_sm[1],
          bottom: dvc.optional.margin_sm[2],
          left: dvc.optional.margin_sm[3]
        };
        var chart_width = parseInt(row.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
      } else if (parseInt(row.style("width")) < threshold_md) {
        var margin = {
          top: dvc.optional.margin_md[0],
          right: dvc.optional.margin_md[1],
          bottom: dvc.optional.margin_md[2],
          left: dvc.optional.margin_md[3]
        };
        var chart_width = parseInt(row.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
      } else {
        var margin = {
          top: dvc.optional.margin_lg[0],
          right: dvc.optional.margin_lg[1],
          bottom: dvc.optional.margin_lg[2],
          left: dvc.optional.margin_lg[3]
        };
        var chart_width = parseInt(row.style("width")) - margin.left - margin.right;
        var height = Math.ceil((chart_width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
      }

      var legend = graphic.append('svg')
        .append("g")
        .attr("id", "legend");

      svg = graphic.select('svg')
        .attr("id", "chart")
        .style("background-color", "#fff")
        .attr("width", chart_width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom) //+30)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      x = d3.scaleLinear()
        .rangeRound([0, chart_width]);

      const range = (from, to, step) =>
        Array(~~((to - from) / step) + 1) // '~~' is Alternative for Math.floor()
        .fill().map((v, i) => from + i * step);

      //set up functions on buttons
      d3.select('#startButton').on('click', function() {
        //grab values
        gender = document.querySelector('input[name="gender"]:checked').value;
        age = +document.getElementById('age').value
        commuteTime = +document.getElementById('commuteTimeInput').value
        income = +document.getElementById('income').value

        d3.select("#part1").classed('d-none', true)
        d3.select("#part2").classed('d-none', false)

        d3.select('#incomeButton').on('click', function() {
          incomeButton()
        })

        byAge(age, gender, commuteTime)
        console.log('startButton', age, gender, commuteTime, income)
      })

      d3.select('#incomeButton').on('click', function() {
        incomeButton()
      })

      function incomeButton() {
        byIncome()
        d3.select('#incomeButton').classed("btn--primary-disabled", true)

        d3.select("#incomeButton").on('click', null)
        d3.select("#restart").classed("btn--primary-disabled", false)
        d3.select("#restart").on('click', function() {
          restart()
        })
      }

      function restart() {
        d3.select('#incomeButton').classed("btn--primary-disabled", false)
        d3.select("#restart").classed("btn--primary-disabled", true)
        d3.select("#part1").classed('d-none', false)
        d3.select("#part2").classed('d-none', true)
        d3.select("#restart").on('click', null)
      }



      function byAge(age, gender, commuteTime) {
        svg.selectAll("*").remove();
        myAgeData = graphic_data.filter(function(d) {
          return +d.Age === +age
        })

        console.log('myAgeData', myAgeData)
        var myDistribution = createDistribution(myAgeData)
        console.log('myDistribution', myDistribution)

        percentile = myDistribution.filter(function(d) {
          return d.Gender == gender
        })[0].values.findIndex(function(d) {
          return d > commuteTime
        })

        console.log("percentile", percentile)

        xMax = d3.max([+myAgeData[0]["D10"], +myAgeData[1]["D10"]])
        x.domain([0, 90]).nice();

        var histos = myDistribution.map(function(d) {
          var thisHisto = d3.histogram()
            .value(function(d) {
              return d
            })
            .domain([0, xMax])
            .thresholds(range(x.domain()[0], 90, 1))

          return {
            gender: d.Gender,
            age: d.Age,
            values: thisHisto(d.values), //.filter(function(d) {
            //return d.length > 0
            //}),
            no: d.values.length
          }
        })
        // console.log(histos)
        xAxis = d3.axisBottom(x)
          .tickFormat(function(d) {
            if (d == x.domain()[1]) {
              return d + "+"
            } else {
              return d
            }
          })
          .tickSize(-height);

        histos.forEach(function(d) {
          var dummy = [];
          d.values.forEach(function(p, i) {
            p.forEach(function(q, j) {
              dummy.push({
                gender: d.gender,
                age: d.age,
                x: p.x0,
                idx: j
              })
            })
          })
          d.circles = dummy;
        })


        console.log('histos', histos)


        circleIndex = histos.filter(function(d) {
          return d.gender == gender
        })[0].values.findIndex(function(d) {
          return d.x0 > commuteTime
        })

        var radius = x(1) - x(0.5)

        if (gender == "Male") {
          circleHeight = -2 * radius * (histos.filter(function(d) {
            return d.gender == gender
          })[0].values[circleIndex - 1].length) - radius
        } else if (gender == "Female") {
          circleHeight = 2 * radius * (histos.filter(function(d) {
            return d.gender == gender
          })[0].values[circleIndex - 1].length) + radius
        }

        maleAverageCommuteTime = myAgeData.filter(function(d) {
          return d.Sex == "Male"
        })[0]["D5"]

        femaleAverageCommuteTime = myAgeData.filter(function(d) {
          return d.Sex == "Female"
        })[0]["D5"]

        yourGenderAverageCommute = myAgeData.filter(function(d) {
          return d.Sex == gender
        })[0]["D5"]

        d3.select("#title").html(function() {
          if (gender == "Male") {
            return (percentile - 1) + "% of men your age have shorter commutes than you."
          } else if (gender == "Female") {
            return (percentile - 1) + "% of women your age have shorter commutes than you."
          }
        })

        d3.select("#subtitle").html("Commute times for people aged " + age + ", Great Britain, 2010 to 2018")

        svg.append('g')
          .attr('class', 'x axis')
          .attr('transform', 'translate(0,' + height + ')')
          .call(xAxis)

        sides = svg.selectAll(".sides")
          .data(histos)
          .enter()
          .append('g')
          .attr('class', 'sides')
          .attr('id', function(d) {
            return d.gender
          })
          .attr('transform', 'translate(0,' + height / 2 + ')')

        sides.append('text')
          .attr('y', function(d) {
            if (d.gender == "Male") {
              return -height / 4
            } else {
              return height / 4
            }
          })
          .attr('font-weight', 700)
          .style('fill', function(d) {
            if (d.gender == "Male") {
              return "#234D70"
            } else {
              return "#00A5A1"
            }
          })
          .text(function(d) {
            if (d.gender == "Male") {
              return "Men"
            } else {
              return "Women"
            }
          })

        sides.selectAll('circle')
          .data(function(d) {
            return d.circles
          })
          .enter()
          .append('circle')
          .attr('r', x(1) - x(0.55))
          .attr('fill', function(d) {
            if (d.gender === "Male") {
              return "#234D70"
            } else if (d.gender === "Female") {
              return "#00A5A1"
            }
          })
          .transition()
          .ease(d3.easeLinear)
          .duration(function(d) {
            return d.x * 40
          })
          .attr('cx', function(d) {
            return x(d.x)
          })
          .attr('cy', function(d) {
            if (d.gender === "Male") {
              return -d.idx * 2 * radius - radius
            } else if (d.gender === "Female") {
              return +d.idx * 2 * radius + radius
            }
          })



        xAxisLabel = svg.append('text')
          .text('minutes')
          .attr('x', chart_width)
          .attr('y', height + margin.bottom - 2)
          .attr('text-anchor', 'end')


        annotations = [{
          note: {
            label: "00:00",
            title: "You"
          },
          x: x(0),
          y: (height / 2) + circleHeight,
          dy: gender == "Female" ? 20 : -20,
          dx: x(commuteTime) < chart_width / 2 ? 40 : -40,
          //color: gender == "Female" ? "#00A5A1" : "#234D70",
          connector:{"end":"arrow"},
          subject: {
            radius: radius,
            radiusPadding: 0
          },
          type: d3.annotationCalloutCircle
        }, {
          note: {
            label: d3.timeFormat("%H:%M")(new Date(new Date("January 01, 2019 00:00:00").getTime() + femaleAverageCommuteTime * 60000)),
            title: "Average commute for a woman your age",
            wrap: chart_width-x(femaleAverageCommuteTime)
          },
          x: x(femaleAverageCommuteTime),
          y: height,
          dy: -1,
          dx: +10,
          className: 'averageLine',
          subject: {
            y1: height,
            y2: height / 2
          },
          type: d3.annotationXYThreshold,
          disable: ["connector"]
        }, {
          note: {
            label: d3.timeFormat("%H:%M")(new Date(new Date("January 01, 2019 00:00:00").getTime() + maleAverageCommuteTime * 60000)),
            title: "Average commute for a man your age",
            wrap: chart_width-x(maleAverageCommuteTime)
          },
          x: x(maleAverageCommuteTime),
          y: 1,
          dy: 0,
          dx: +10,
          className: 'averageLine',
          subject: {
            y1: 0,
            y2: height / 2
          },
          type: d3.annotationXYThreshold,
          disable: ["connector"]
        }]

        makeAnnotations = d3.annotation()
          .annotations(annotations)

        svg.append('g')
          .data(annotations)
          .attr('class', 'annotation-group')
          .call(makeAnnotations)



        d3.transition()
          .duration(commuteTime * 40)
          .ease(d3.easeLinear)
          .tween('updateAnno', function(d, i) {
            xTrans = d3.interpolateNumber(0, commuteTime)
            timeTrans = d3.interpolateDate(new Date("January 01, 2019 00:00:00"), new Date(new Date("January 01, 2019 00:00:00").getTime() + commuteTime * 60000))

            return function(t) {
              annotations[i].x = x(xTrans(t));
              annotations[0].note.label = d3.timeFormat("%H:%M")(timeTrans(t))
              makeAnnotations.annotations(annotations)
              makeAnnotations.update()
            }
          })

        d3.selectAll(".averageLine").transition()
          .delay(commuteTime * 80)
          .transition()
          .style('opacity', 1)
          .attr('stroke-dasharray', '4 4')


      } //end of byAge


      function byIncome() {
        console.log('Income button')

        d3.selectAll(".averageLine").transition()
          .style('opacity', 0)

        sides.selectAll('circle')
          .transition()
          .attr('cx', x(commuteTime))
          .transition()
          .delay(500)
          .attr('cy', -height / 2)

        d3.transition()
          .delay(750)
          .tween('updateAnno', function(d) {
            yTrans = d3.interpolateNumber(height / 2, 0)

            return function(t) {
              annotations[0].y = yTrans(t);
              annotations[0].note.label = ""
              makeAnnotations.annotations(annotations)
              makeAnnotations.update()
            }
          })


        //find commute time band
        myIncomeData = income_data.filter(function(d) {
            return +d.commuteMin <= commuteTime && +d.commuteMax > commuteTime
          })
          .filter(function(d) {
            return +d.ageMin <= age && +d.ageMax > age
          })

        console.log(myIncomeData)
        var myDistribution = createDistribution(myIncomeData)
        console.log(myDistribution)

        incomePercentile = myDistribution.filter(function(d) {
          return d.Gender == gender
        })[0].values.findIndex(function(d) {
          return d > income
        })

        console.log('incomePercentile', incomePercentile)

        var incomeXMax = d3.max([myIncomeData[0]["D10"], myIncomeData[1]["D10"]])

        x.range([0, 0])
        d3.select('.x').transition().duration(750).call(d3.axisBottom(x))

        x.range([0, chart_width])
          .domain([0, 60]).nice()
        d3.select('.x')
          .transition()
          .delay(750)
          .duration(750)
          .call(d3.axisBottom(x).tickFormat(function(d) {
              if (d == x.domain()[1]) {
                return d + "+"
              } else {
                return d
              }
            })
            .tickSize(-height))

        xAxisLabel.transition().text("£ per hour")

        var histos = myDistribution.map(function(d) {
          var thisHisto = d3.histogram()
            .value(function(d) {
              return d
            })
            .domain([0, incomeXMax])
            .thresholds(range(x.domain()[0], 60, 0.6))

          return {
            gender: d.Gender,
            values: thisHisto(d.values),
          }
        })
        // console.log(histos)
        var xAxis = d3.axisBottom(x);

        histos.forEach(function(d) {
          var dummy = [];
          d.values.forEach(function(p, i) {
            p.forEach(function(q, j) {
              dummy.push({
                gender: d.gender,
                x: p.x0,
                idx: j
              })
            })
          })
          d.circles = dummy;
        })

        incomeCircleIndex = histos.filter(function(d) {
          return d.gender == gender
        })[0].values.findIndex(function(d) {
          return d.x0 > income
        })

        var radius = x(x.domain()[1] / 100) * 0.45

        if (gender == "Male") {
          incomeCircleHeight = -2 * radius * (histos.filter(function(d) {
            return d.gender == gender
          })[0].values[incomeCircleIndex - 1].length) - radius
        } else if (gender == "Female") {
          incomeCircleHeight = 2 * radius * (histos.filter(function(d) {
            return d.gender == gender
          })[0].values[incomeCircleIndex - 1].length) + radius
        }

        console.log('histos', histos)

        maleAverageIncome = myIncomeData.filter(function(d) {
          return d.Sex == "Male"
        })[0]["D5"]

        femaleAverageIncome = myIncomeData.filter(function(d) {
          return d.Sex == "Female"
        })[0]["D5"]

        yourGenderIncome = myIncomeData.filter(function(d) {
          return d.Sex == gender
        })[0]["D5"]

        var commuteMin = myIncomeData.filter(function(d) {
          return d.Sex == gender
        })[0].commuteMin
        var commuteMax = myIncomeData.filter(function(d) {
          return d.Sex == gender
        })[0].commuteMax
        var ageMin = myIncomeData.filter(function(d) {
          return d.Sex == gender
        })[0].ageMin
        var ageMax = myIncomeData.filter(function(d) {
          return d.Sex == gender
        })[0].ageMax


        //delete last two annotations before adding more
        annotations.pop()
        annotations.pop()

        annotations[0].dx=x(income) < chart_width / 2 ? 80 : -80

        annotations.push({
          note: {
            label: "£" + d3.format(".2f")(femaleAverageIncome) + " per hour",
            title: "Average earnings for a woman with a similar age and commute",
            wrap: 250
          },
          x: x(femaleAverageIncome),
          y: height,
          dy: -1,
          dx: +10,
          className: 'averageLine',
          subject: {
            y1: height,
            y2: height / 2
          },
          type: d3.annotationXYThreshold,
          disable: ["connector"]
        })
        annotations.push({
          note: {
            label: "£" + d3.format(".2f")(maleAverageIncome) + " per hour",
            title: "Average earnings for a man with a similar age and commute",
            wrap: 250
          },
          x: x(maleAverageIncome),
          y: 1,
          dy: 0,
          dx: +10,
          className: 'averageLine',
          subject: {
            y1: 0,
            y2: height / 2
          },
          type: d3.annotationXYThreshold,
          disable: ["connector"]
        })

        makeAnnotations.annotations(annotations)
        makeAnnotations.update()

        d3.select("#title").html(function() {
          if (gender == "Male") {
            return "You earn more than " + (incomePercentile - 1) + "% of men around your age who do a similar commute"
          } else if (gender == "Female") {
            return "You earn more than " + (incomePercentile - 1) + "% of women around your age who do a similar commute"
          }
        })

        d3.select("#subtitle").html("Hourly earnings for people aged between " + ageMin + " and " + ageMax + " who commute " + commuteMin + "–" + commuteMax + " minutes, Great Britain, 2010 to 2018")

        sides = svg.selectAll(".sides")
          .data(histos)

        sides.selectAll('circle')
          .data(function(d) {
            return d.circles
          })
          .transition()
          .delay(1500)
          .ease(d3.easeLinear)
          .duration(1500)
          .attr('cx', function(d) {
            return x(d.x)
          })
          .attr('r', radius)
          .attr('cy', function(d) {
            if (d.gender === "Male") {
              return -d.idx * 2 * radius - radius
            } else if (d.gender === "Female") {
              return +d.idx * 2 * radius + radius
            }
          })

        d3.transition()
          .delay(1500)
          .duration(1500)
          .ease(d3.easeLinear)
          .tween('updateAnno', function(d) {
            var xTrans = d3.interpolateNumber(annotations[0].x, x(income))
            var yTrans = d3.interpolateNumber(0, height / 2 + incomeCircleHeight)
            var incomeTrans = d3.interpolateNumber(0, income)

            return function(t) {
              annotations[0].x = xTrans(t);
              annotations[0].y = yTrans(t)
              annotations[0].note.label = "£" + d3.format(",.2f")(incomeTrans(t))
              makeAnnotations.annotations(annotations)
              makeAnnotations.update()
            }
          })


        d3.selectAll(".averageLine")
          .transition()
          .delay(3000)
          .style('opacity', 1)



      } // end by income

    } // ends drawGraphic



    function createDistribution(data) {
      var dummy = []
      test = data.map(function(d) {
        var filled = []
        fillNumbers(9, [d.P1, d.D1]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D1, d.D2]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D2, d.D3]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D3, d.D4]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D4, d.D5]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D5, d.D6]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D6, d.D7]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D7, d.D8]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D8, d.D9]).forEach(function(e) {
          filled.push(e)
        })
        fillNumbers(10, [d.D9, d.D10]).forEach(function(e) {
          filled.push(e)
        })
        dummy.push({
          Gender: d.Sex,
          values: filled
        });
      })
      return dummy
    }



    function fillNumbers(N, fillrange) {
      var count = +N;
      var res = [];
      var step = (fillrange[1] - fillrange[0]) / count
      var v0 = +fillrange[0];
      for (i = 0; i < N; i++) {
        var tmp = v0 + (i * +step);
        res.push(Math.round(tmp * 1e3) / 1000)
      }
      return res
    }

    function loadData(error, results) {
      if (error) throw error;
      graphic_data = results[0];
      income_data = results[1];

      pymChild = new pym.Child({
        renderCallback: drawGraphic
      });
    }

    //check whether browser can cope with svg
    if (Modernizr.svg) {
      //load config
      d3.json("config.json", function(error, config) {
        dvc = config

        //load chart data
        q = d3.queue()
        dvc.essential.graphic_data_url.forEach(function(d) {
          q.defer(d3.csv, d)
        })
        q.awaitAll(loadData)
      })

    } else {
      //use pym to create iframe containing fallback image (which is set as default)
      pymChild = new pym.Child();
      if (pymChild) {
        pymChild.sendHeight();
      }
    }

    //findIndex polyfill
    if (!Array.prototype.findIndex) {
      Object.defineProperty(Array.prototype, 'findIndex', {
        value: function(predicate) {
          // 1. Let O be ? ToObject(this value).
          if (this == null) {
            throw new TypeError('"this" is null or not defined');
          }

          var o = Object(this);

          // 2. Let len be ? ToLength(? Get(O, "length")).
          var len = o.length >>> 0;

          // 3. If IsCallable(predicate) is false, throw a TypeError exception.
          if (typeof predicate !== 'function') {
            throw new TypeError('predicate must be a function');
          }

          // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
          var thisArg = arguments[1];

          // 5. Let k be 0.
          var k = 0;

          // 6. Repeat, while k < len
          while (k < len) {
            // a. Let Pk be ! ToString(k).
            // b. Let kValue be ? Get(O, Pk).
            // c. Let testResult be ToBoolean(? Call(predicate, T, « kValue, k, O »)).
            // d. If testResult is true, return k.
            var kValue = o[k];
            if (predicate.call(thisArg, kValue, k, o)) {
              return k;
            }
            // e. Increase k by 1.
            k++;
          }

          // 7. Return -1.
          return -1;
        },
        configurable: true,
        writable: true
      });
    }
  </script>
</body>

</html>
